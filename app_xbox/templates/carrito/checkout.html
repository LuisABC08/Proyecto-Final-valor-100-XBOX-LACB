{% extends 'base.html' %}

{% block title %}Finalizar la compra - Microsoft Store{% endblock %}

{% block content %}
<div class="container py-5" style="background-color: #f2f2f2; min-height: 90vh;">
    
    <div class="row g-5 justify-content-center">
        
        <!-- COLUMNA DERECHA: RESUMEN (Sticky) -->
        <div class="col-md-5 col-lg-4 order-md-last">
            <div class="bg-white p-4 shadow-sm border">
                <h4 class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-secondary fw-bold">Resumen del pedido</span>
                    <span class="badge bg-xbox rounded-pill">{{ pedido.items.count }}</span>
                </h4>
                <ul class="list-group list-group-flush mb-3">
                    {% for item in pedido.items.all %}
                    <li class="list-group-item d-flex justify-content-between lh-sm px-0">
                        <div>
                            <h6 class="my-0 small fw-bold">{{ item.producto.nombre }}</h6>
                            <small class="text-muted">Cant: {{ item.cantidad }}</small>
                        </div>
                        <span class="text-muted small">${{ item.subtotal }}</span>
                    </li>
                    {% endfor %}
                    <li class="list-group-item d-flex justify-content-between px-0 pt-3">
                        <span>Subtotal</span>
                        <strong>${{ pedido.total }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between px-0">
                        <span>Envío</span>
                        <span class="text-success fw-bold">Gratis</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between px-0 pb-0 border-0">
                        <span class="h5 fw-bold">Total a pagar</span>
                        <span class="h4 fw-bold text-dark">${{ pedido.total }}</span>
                    </li>
                </ul>
            </div>
            
            <div class="mt-3 text-center text-muted small">
                <i class="bi bi-shield-lock-fill"></i> Transacción segura SSL
            </div>
        </div>

        <!-- COLUMNA IZQUIERDA: DATOS Y PAGO -->
        <div class="col-md-7 col-lg-8">
            <h2 class="fw-bold mb-4">Finalizar la compra</h2>
            
            <form method="POST" class="needs-validation" novalidate id="payment-form">
                {% csrf_token %}

                <!-- 1. DIRECCIÓN DE ENVÍO -->
                <div class="bg-white p-4 shadow-sm border mb-4">
                    <h4 class="mb-3 fw-bold">1. Dirección de envío</h4>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Nombre completo</label>
                            <input type="text" class="form-control" name="nombre_completo" required value="{{ user.cliente.user.first_name }} {{ user.cliente.user.last_name }}">
                        </div>

                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Dirección (Calle y número)</label>
                            <input type="text" class="form-control" name="direccion" placeholder="Ej: Av. Reforma 123" required>
                        </div>

                        <div class="col-md-5">
                            <label class="form-label small fw-bold text-muted">País</label>
                            <select class="form-select" required>
                                <option value="MX">México</option>
                                <option>Estados Unidos</option>
                                <option>España</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Estado / Ciudad</label>
                            <input type="text" class="form-control" placeholder="Ej: CDMX" required>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Código Postal</label>
                            <input type="text" class="form-control" placeholder="00000" required>
                        </div>
                    </div>
                </div>

                <!-- 2. MÉTODO DE PAGO -->
                <div class="bg-white p-4 shadow-sm border">
                    <h4 class="mb-3 fw-bold">2. Método de pago</h4>
                    
                    <div class="my-3">
                        <div class="form-check">
                            <input id="credit" name="paymentMethod" type="radio" class="form-check-input" checked>
                            <label class="form-check-label fw-bold" for="credit">Tarjeta de Crédito / Débito</label>
                            <div class="ms-2 d-inline-block">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" height="15" class="opacity-75">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" height="15" class="opacity-75 ms-1">
                            </div>
                        </div>
                        <div class="form-check">
                            <input id="paypal" name="paymentMethod" type="radio" class="form-check-input">
                            <label class="form-check-label fw-bold" for="paypal">PayPal</label>
                        </div>
                    </div>

                    <div id="card-details" class="row gy-3 mt-2 p-3 bg-light rounded border">
                        <!-- Nombre en Tarjeta -->
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Nombre en la tarjeta</label>
                            <input type="text" class="form-control" placeholder="Como aparece en el plástico" required>
                            <small class="text-muted">Nombre completo del titular</small>
                        </div>

                        <!-- NÚMERO DE TARJETA (Validado con JS) -->
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Número de tarjeta</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-credit-card"></i></span>
                                <input type="text" 
                                       class="form-control border-start-0" 
                                       id="cc-number" 
                                       placeholder="0000 0000 0000 0000" 
                                       maxlength="16" 
                                       required>
                            </div>
                            <!-- Mensaje de error oculto -->
                            <div id="cc-error" class="text-danger small mt-1" style="display:none;">
                                Debe contener 16 dígitos.
                            </div>
                        </div>

                        <!-- Fecha de Expiración -->
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Expiración</label>
                            <input type="text" class="form-control text-center" placeholder="MM/YY" maxlength="5" required>
                        </div>

                        <!-- CVV -->
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">CVV</label>
                            <input type="text" class="form-control text-center" placeholder="123" maxlength="4" required>
                            <small class="text-muted">Código de seguridad</small>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <button class="w-100 btn btn-xbox-primary btn-lg shadow-sm" type="submit" id="btn-submit">
                    Pagar ${{ pedido.total }}
                </button>
            </form>
        </div>
    </div>
</div>

<!-- SCRIPT DE VALIDACIÓN -->
<script>
    // 1. Control del Número de Tarjeta (Solo números y max 16)
    const ccInput = document.getElementById('cc-number');
    const ccError = document.getElementById('cc-error');

    ccInput.addEventListener('input', function(e) {
        // Eliminar cualquier caracter que NO sea número
        this.value = this.value.replace(/\D/g, '');
        
        // El maxlength="16" del HTML ya limita la longitud, 
        // pero esto asegura que si pegan texto, se limpie.
    });

    // 2. Validación antes de enviar el formulario
    document.getElementById('payment-form').addEventListener('submit', function(event) {
        // Verificar longitud exacta de 16
        if (ccInput.value.length < 16) {
            event.preventDefault(); // Detener el envío
            ccInput.classList.add('is-invalid');
            ccError.style.display = 'block';
            ccInput.focus();
        } else {
            ccInput.classList.remove('is-invalid');
            ccError.style.display = 'none';
        }
    });
</script>

{% endblock %}