{% extends 'base.html' %}

{% block title %}Consolas Xbox{% endblock %}

{% block content %}

<!-- TÍTULO -->
<div class="text-center py-5">
    <h1 class="fw-bold display-4">VER CONSOLAS <span class="text-xbox">XBOX</span></h1>
    <div style="height: 5px; width: 50px; background-color: #9bf00b; margin: 10px auto;"></div>
</div>

<div class="container mb-5">
    <div class="row">
        
        <!-- SIDEBAR DE FILTROS (AHORA FUNCIONAL) -->
        <div class="col-md-3 d-none d-md-block">
            <!-- INICIO DEL FORMULARIO DE FILTROS -->
            <form method="GET" action="{% url 'lista_consolas' %}">
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0">Consolas ({{ consolas.count }})</h5>
                    <!-- Botón para limpiar filtros si hay alguno activo -->
                    {% if request.GET %}
                        <a href="{% url 'lista_consolas' %}" class="text-success small text-decoration-none">Borrar filtros</a>
                    {% endif %}
                </div>
                
                <!-- 1. BUSCADOR -->
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control" placeholder="Buscar..." value="{{ request.GET.q }}">
                        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                </div>

                <!-- ACORDEÓN DE FILTROS -->
                <div class="accordion accordion-flush" id="filtrosAccordion">
                    
                    <!-- 2. MODELOS (Series X / S) -->
                    <div class="accordion-item bg-transparent">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-light fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConsolas">
                                Consolas
                            </button>
                        </h2>
                        <div id="collapseConsolas" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="modelo" value="Series X" id="checkX" 
                                    {% if 'Series X' in filtros_activos.modelo %}checked{% endif %}>
                                    <label class="form-check-label" for="checkX">Xbox Series X</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="modelo" value="Series S" id="checkS"
                                    {% if 'Series S' in filtros_activos.modelo %}checked{% endif %}>
                                    <label class="form-check-label" for="checkS">Xbox Series S</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. ALMACENAMIENTO (Dinámico desde DB) -->
                    <div class="accordion-item bg-transparent">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-light fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStorage">
                                Almacenamiento
                            </button>
                        </h2>
                        <div id="collapseStorage" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                {% for espacio in opciones_almacenamiento %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="almacenamiento" value="{{ espacio }}" id="store_{{ forloop.counter }}"
                                    {% if espacio in filtros_activos.almacenamiento %}checked{% endif %}>
                                    <label class="form-check-label" for="store_{{ forloop.counter }}">{{ espacio }}</label>
                                </div>
                                {% empty %}
                                <small class="text-muted">No hay opciones</small>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- 4. COLOR (Dinámico desde DB) -->
                    <div class="accordion-item bg-transparent">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-light fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseColor">
                                Color
                            </button>
                        </h2>
                        <div id="collapseColor" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                {% for color in opciones_color %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="color" value="{{ color }}" id="color_{{ forloop.counter }}"
                                    {% if color in filtros_activos.color %}checked{% endif %}>
                                    <label class="form-check-label" for="color_{{ forloop.counter }}">{{ color }}</label>
                                </div>
                                {% empty %}
                                <small class="text-muted">No hay opciones</small>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                </div> <!-- Fin Accordion -->

                <!-- BOTÓN APLICAR -->
                <div class="d-grid mt-3">
                    <button type="submit" class="btn btn-dark btn-sm">Aplicar Filtros</button>
                </div>

            </form>
            <!-- FIN DEL FORMULARIO -->
        </div>

        <!-- LISTA DE PRODUCTOS (LADO DERECHO) -->
        <div class="col-md-9">
            <!-- Botón Admin -->
            {% if user.is_staff %}
                <div class="mb-3 text-end">
                    <a href="{% url 'crear_consola' %}" class="btn btn-dark btn-sm"><i class="bi bi-plus"></i> Admin: Agregar Consola</a>
                </div>
            {% endif %}

            <div class="row row-cols-1 row-cols-md-3 g-5">
                {% for consola in consolas %}
                <div class="col">
                    <div class="card card-clean h-100">
                        <a href="{% url 'detalle_consola' consola.ID_consola %}">
                            <div style="height: 250px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                <img src="{% if consola.imagen %}{{ consola.imagen.url }}{% endif %}" 
                                     class="card-img-top" 
                                     alt="{{ consola.nombre }}"
                                     style="max-height: 100%; width: auto; padding: 10px;">
                            </div>
                        </a>

                        <div class="card-body px-0">
                            <h5 class="card-title mb-2">{{ consola.nombre }}</h5>
                            
                            <div class="d-flex flex-column gap-2 mt-3">
<!-- ASÍ DEBE VERSE EL BOTÓN DE COMPRA -->
{% if not user.is_staff %} <!-- SI NO ES ADMIN, MUESTRA COMPRAR -->
    {% if consola.stock > 0 %}
        <a href="{% url 'agregar_carrito' 'consola' consola.ID_consola %}" class="xbox-link">
            COMPRAR AHORA <i class="bi bi-chevron-right"></i>
        </a>
    {% else %}
        <span class="text-danger small fw-bold">AGOTADO</span>
    {% endif %}
{% endif %}
                                <a href="{% url 'detalle_consola' consola.ID_consola %}" class="xbox-link">
                                    MÁS INFORMACIÓN <i class="bi bi-chevron-right"></i>
                                </a>
                                
                                {% if user.is_staff %}
                                <div class="mt-2 border-top pt-2">
                                    <a href="{% url 'editar_consola' consola.ID_consola %}" class="text-secondary small me-2">Editar</a>
                                    <a href="{% url 'eliminar_consola' consola.ID_consola %}" class="text-danger small">Borrar</a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h3 class="mt-3">No encontramos resultados.</h3>
                    <p>Prueba ajustando los filtros o la búsqueda.</p>
                    <a href="{% url 'lista_consolas' %}" class="btn btn-xbox-primary">Ver todo</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Sección de Iconos Verdes abajo -->
    <div class="row text-center mt-5 pt-5">
        <div class="col-md-3">
            <i class="bi bi-controller display-4 text-dark"></i>
            <h6 class="mt-2 fw-bold text-xbox">JUEGOS ></h6>
        </div>
        <div class="col-md-3">
            <i class="bi bi-xbox display-4 text-dark"></i>
            <h6 class="mt-2 fw-bold text-xbox">XBOX GAME PASS ></h6>
        </div>
        <div class="col-md-3">
            <i class="bi bi-headset display-4 text-dark"></i>
            <h6 class="mt-2 fw-bold text-xbox">ACCESORIOS ></h6>
        </div>
        <div class="col-md-3">
            <i class="bi bi-person-headset display-4 text-dark"></i>
            <h6 class="mt-2 fw-bold text-xbox">SOPORTE TÉCNICO ></h6>
        </div>
    </div>
</div>
{% endblock %}